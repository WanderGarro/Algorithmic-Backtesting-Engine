{% extends 'trading/base.html' %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ç–∫—Ç–µ—Å—Ç–∞ - –¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-graph-up"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ç–∫—Ç–µ—Å—Ç–∞
            </h1>
            <a href="{% url 'backtest' %}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> –ù–æ–≤—ã–π —Ç–µ—Å—Ç
            </a>
        </div>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card metric-card text-center bg-success text-white">
            <div class="card-body">
                <h4 class="card-title">{{ result.total_return|floatformat:2 }}%</h4>
                <p class="card-text">–û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</p>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card metric-card text-center bg-info text-white">
            <div class="card-body">
                <h4 class="card-title">{{ result.sharpe_ratio|floatformat:2 }}</h4>
                <p class="card-text">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞</p>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card metric-card text-center bg-warning text-white">
            <div class="card-body">
                <h4 class="card-title">{{ result.max_drawdown|floatformat:2 }}%</h4>
                <p class="card-text">–ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞</p>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card metric-card text-center bg-primary text-white">
            <div class="card-body">
                <h4 class="card-title">{{ result.win_rate|floatformat:1 }}%</h4>
                <p class="card-text">Win Rate</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- –ì—Ä–∞—Ñ–∏–∫ –∫—Ä–∏–≤–æ–π –∫–∞–ø–∏—Ç–∞–ª–∞ -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">–ö—Ä–∏–≤–∞—è –∫–∞–ø–∏—Ç–∞–ª–∞</h5>
            </div>
            <div class="card-body">
                <div id="equity-chart" class="equity-chart">
                    {% if result.equity_curve_data %}
                    <canvas id="equityChart"></canvas>
                    {% else %}
                    <div class="text-center text-muted p-5">
                        <i class="bi bi-exclamation-triangle display-4 d-block mb-3"></i>
                        <p>–î–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td>–°—Ç—Ä–∞—Ç–µ–≥–∏—è:</td>
                        <td class="text-end">{{ result.get_strategy_display }}</td>
                    </tr>
                    <tr>
                        <td>–¢–∏–∫–µ—Ä:</td>
                        <td class="text-end"><strong>{{ result.symbol }}</strong></td>
                    </tr>
                    <tr>
                        <td>–ü–µ—Ä–∏–æ–¥:</td>
                        <td class="text-end">{{ result.start_date|date:"d.m.Y" }} - {{ result.end_date|date:"d.m.Y" }}</td>
                    </tr>
                    <tr>
                        <td>–ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª:</td>
                        <td class="text-end">${{ result.initial_capital|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</td>
                        <td class="text-end">${{ result.final_portfolio_value|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫:</td>
                        <td class="text-end">{{ result.total_trades }}</td>
                    </tr>
                    <tr>
                        <td>–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞:</td>
                        <td class="text-end">{{ result.created_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">–î–µ–π—Å—Ç–≤–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'history' %}" class="btn btn-outline-primary">
                        <i class="bi bi-clock-history"></i> –ö –∏—Å—Ç–æ—Ä–∏–∏
                    </a>
                    <a href="{% url 'export_result' result.id %}" class="btn btn-outline-success" id="export-csv-btn">
                        <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    </a>
                    <form method="post" action="{% url 'delete_result' result.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?')">
                            <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —Å–¥–µ–ª–æ–∫ -->
{% if result.trades_data %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–¶–µ–Ω–∞</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                <th>PnL</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in result.trades_data %}
                            <tr class="{% if trade.action == 'BUY' %}table-success{% else %}table-danger{% endif %}">
                                <td>{{ trade.timestamp|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <span class="badge {% if trade.action == 'BUY' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ trade.action }}
                                    </span>
                                </td>
                                <td>${{ trade.price|floatformat:2 }}</td>
                                <td>{{ trade.quantity|floatformat:0 }}</td>
                                <td>${{ trade.value|floatformat:2 }}</td>
                                <td class="{% if trade.pnl_percent >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ trade.pnl_percent|floatformat:2 }}%
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if result.equity_curve_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartCtx = null;
let chartInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    try {
        chartCtx = document.getElementById('equityChart');
        if (!chartCtx) return;

        const equityData = {{ result.equity_curve_data|safe }};

        if (!equityData || typeof equityData !== 'object') {
            throw new Error('Invalid equity data format');
        }

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const datasets = [];
        const labels = [];

        // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫—Ä–∏–≤—ã—Ö
        const colors = {
            'total': { border: '#0d6efd', background: 'rgba(13, 110, 253, 0.1)' },
            'cash': { border: '#28a745', background: 'rgba(40, 167, 69, 0.1)' },
            'stocks': { border: '#ffc107', background: 'rgba(255, 193, 7, 0.1)' }
        };

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∫—Ä–∏–≤—É—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç
        const firstCurveName = Object.keys(equityData)[0];
        if (equityData[firstCurveName]) {
            const entries = Object.entries(equityData[firstCurveName]);
            entries.sort((a, b) => new Date(a[0]) - new Date(b[0]));

            entries.forEach(([dateString, value]) => {
                const date = new Date(dateString);
                const formattedDate = `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()}`;
                labels.push(formattedDate);
            });
        }

        // –°–æ–∑–¥–∞–µ–º datasets –¥–ª—è –∫–∞–∂–¥–æ–π –∫—Ä–∏–≤–æ–π
        Object.entries(equityData).forEach(([curveName, curveData]) => {
            const entries = Object.entries(curveData);
            entries.sort((a, b) => new Date(a[0]) - new Date(b[0]));

            const data = entries.map(([_, value]) => parseFloat(value) || 0);

            const curveConfig = {
                label: getCurveLabel(curveName),
                data: data,
                borderColor: colors[curveName]?.border || getRandomColor(),
                backgroundColor: colors[curveName]?.background || 'rgba(0,0,0,0.1)',
                borderWidth: 2,
                fill: curveName === 'total',
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 3
            };

            datasets.push(curveConfig);
        });

        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
        chartInstance = new Chart(chartCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                return `${label}: $${value.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxRotation: 45,
                            callback: function(value, index, ticks) {
                                if (ticks.length > 15 && index % Math.ceil(ticks.length / 8) !== 0) {
                                    return null;
                                }
                                return this.getLabelForValue(value);
                            }
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: { color: 'rgba(0,0,0,0.1)' },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('ru-RU');
                            }
                        }
                    }
                }
            }
        });

    } catch (error) {
        console.error('Error loading chart:', error);
        showChartError(error);
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –∫—Ä–∏–≤—ã—Ö
function getCurveLabel(curveName) {
    const labels = {
        'total': 'üí∞ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å',
        'cash': 'üíµ –î–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞',
        'stocks': 'üìà –°—Ç–æ–∏–º–æ—Å—Ç—å –∞–∫—Ü–∏–π'
    };
    return labels[curveName] || curveName;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
function getRandomColor() {
    return '#' + Math.floor(Math.random()*16777215).toString(16);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–º
function toggleDataset(datasetName) {
    if (!chartInstance) return;

    const datasetIndex = chartInstance.data.datasets.findIndex(ds =>
        ds.label.includes(getLabelPart(datasetName))
    );

    if (datasetIndex !== -1) {
        const meta = chartInstance.getDatasetMeta(datasetIndex);
        meta.hidden = !meta.hidden;
        chartInstance.update();
    }
}

function getLabelPart(name) {
    const parts = {
        'total': '–û–±—â–∞—è',
        'cash': '–î–µ–Ω–µ–∂–Ω—ã–µ',
        'stocks': '–ê–∫—Ü–∏–π'
    };
    return parts[name] || name;
}

function showChartError(error) {
    const chartContainer = document.getElementById('equity-chart');
    if (chartContainer) {
        chartContainer.innerHTML = `
            <div class="text-center text-muted p-5">
                <i class="bi bi-exclamation-triangle display-4 d-block mb-3"></i>
                <h5>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</h5>
                <p class="small">${error.message}</p>
            </div>
        `;
    }
}
</script>
{% endif %}

<style>
.equity-chart {
    height: 475px;
    position: relative;
}
.metric-card .card-title {
    font-size: 1.5rem;
    font-weight: bold;
}
.chart-controls .btn-group {
    flex-wrap: wrap;
}
.chart-controls .btn {
    margin: 1px;
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
}
</style>
{% endblock %}